# loevの設計思想

## 設計目標

- 様々なファイルの比較に応用しやすい構造にする
- 個々のプログラムを生成AIで扱える規模に抑える
- 容易に処理過程と構造を理解でき、職員が修正できるようにする
- 処理過程を確認し後から検証できるよう中間生成ファイルを全て残す
- abr-geocoderなどの外部プログラムを容易に呼び出せるようにする
- プログラムの呼び出し方で柔軟にカラムを追加削除できるようにする
- 追加したカラムに応じて容易に比較モジュールを追加できるようにする
- 実行環境をUSBメモリ等で容易に持ち運べるようにする（できれば）

## 各プログラムの作成に使ったプロンプト

### csv-split プログラムの作成

CSVファイルを属性カラム毎に分離するcsv-splitプログラムを作成してください。csv-splitは番号、属性1、属性2、属性3といったCSVファイルのファイル名を入力として受け取り、番号, 属性1、番号, 属性2、番号, 属性3といった別々のCSVファイルを出力します。
CSVファイルに含まれる属性の数は可変で、先頭カラムは番号、2番目以降のカラムには任意の属性をとり、属性の数分のファイルに分割します。出力する番号, 属性1のファイル名は 元のファイル名_1.csv、属性2のファイル名は 元のファイル名_2.csvといったファイル名とします。

### cmp-cat プログラムの作成

比較ファイルを結合するcmp-concat プログラムを作成してください。cmp-concat プログラムは複数の比較ファイルを受け取り、全ての行を含む all.csv ファイルと、差分のある行のみを含む diff.csv ファイルを出力します。cmp-catプログラムはまず、与えられた全てのCSVファイルの行数が同じであることを確認して下さい。行数が異なる場合はエラーを出力して終了してください。各比較ファイルはCSV形式で、先頭カラムで差分がない場合は 0 差分がある場合は0以外の数値が書き込まれます。それぞれのcmpファイルには、番号、差分評価の数値、srcの値、refの値のカラムが含まれます。出力ファイルの形式は、番号、ファイル1の先頭カラム、ファイル2の先頭カラム、ファイル3の先頭カラム、ファイル1の他カラム、ファイル2の他カラム、ファイル3の他カラムとなります。出力ファイルのファイル名は all.csv と diff.csv としてください。all.csvには全ての行、diff.csvにはいずれかの差分評価の数値でゼロ以外の値が入っている行を出力してください。

### name-cmp プログラムの作成

名前を比較するname-cmp プログラムを作成してください。name-cmp プログラムは2つのCSVファイルを受け取り、名前の差分を検出します。2つのCSVファイル名はコマンドライン引数として取得しそれぞれ内部的にはsrc、refとして扱います。入力されるCSVファイルはそれぞれ番号、氏名の2カラムを持ちます。番号をキーとして2つのファイルをソートして氏名を比較し、番号の次のカラムを差分結果数値とします。
まず氏名の異体字を吸収するため、data/itaiji.csvから正字、異体字の順のカラムを持つ異体字リストを読み取って、全ての異体字を正字に置き換えてください。[]などの括弧に囲まれた文字は削除してください。アルファベットは全て半角大文字に変換してください。全角半角の空白は削除してください。代替文字を data/filler.csv から読み込んでワイルドカードとして扱い、一致しているものとして、同じ位置関係にある他の文字を比較してください。差分評価数値として、ワイルドカードを無視して一致した場合は処理したワイルドカードの数、完全一致した場合は0、不一致は9としてください。片方のファイルにしかない氏名は、もう片方の氏名を「該当なし」として、差分評価数値を-1としてください。出力ファイルのカラムは、番号、差分評価数値、srcの名前、refの名前となります。出力ファイルのファイル名は name_cmp.csv として、入力ファイルと同じディレクトリに出力してください。

### geo-cmp プログラムの作成

2つの住所ファイルをマージするgeo-catプログラムをPythonで作成してください。プログラムは2つのファイルをコマンドライン引数に持ちます。それぞれの住所ファイルは番号、住所の2カラムを持ちます。番号をキーとして2つのファイルをソートし、番号、住所1、住所2のファイルを geo_cat.csv、住所1、住所2、次の行の住所1、住所2...という住所だけが並んだテキストファイルをgeo_address.csvとして作成し、入力ファイルと同じディレクトリに出力してください。片方のファイルにしかない住所は、もう片方の住所を「該当なし」としてください。

abr-geocoder で address.csvを address.jsonに変換します。

住所を比較するgeo-cmp プログラムを作成してください。geo-cmp プログラムは引数として geo_cat.csv と address.jsonを受け取ります。まずaddress.jsonに含まれる {}の数が、geo_cat.csvのちょうど倍であることを確認します。倍でない場合はエラーを出力してプログラムを終了します。address.jsonに含まれるlat lon要素を緯度経度として取り出し、次の行のlat lon要素との間の距離を計算し、その結果をgeo_cat.csvの要素の先頭に追加し、geo_cmp.csvを作成します。geo_cmp.csvのカラムは、番号、距離、住所1、住所2となります。

### date-cmp プログラムの作成

日付を比較するdate-cmp プログラムを作成してください。date-cmp プログラムは2つのCSVファイルを受け取り、日付の差分を検出します。2つのCSVファイル名はコマンドライン引数として取得しそれぞれ内部的にはsrc、refとして扱います。入力されるCSVファイルはそれぞれ番号、日付の2カラムを持ちます。番号をキーとして2つのファイルをソートして日付を比較し、番号の次のカラムを2つの日付の差分となる日数の絶対値とします。出力ファイルのカラムは、番号、差分の日数、srcの日付、refの日付となります。入力される日付の記述に表記揺れがあっても柔軟に対応してください。出力ファイルのファイル名は date_cmp.csv として、入力ファイルと同じディレクトリに出力してください。片方のファイルにしかない日付は、もう片方の住所を「該当なし」として、日数を-1としてください。

### kana-cmp プログラムの作成

カナを比較する kana-cmp プログラムを作成してください。 kana-cmp プログラムは2つのCSVファイルを受け取り、カナの差分を検出します。2つのCSVファイル名はコマンドライン引数として取得しそれぞれ内部的にはsrc、refとして扱います。入力されるCSVファイルはそれぞれ番号、カナの2カラムを持ちます。番号をキーとして2つのファイルをソートしてカナを比較し、番号の次のカラムを2つのカナの差分の有無を示すフラグとします。一致している場合はゼロ、一致していない場合は1、片方のファイルにしかない場合はカナを「該当なし」として、フラグを-1としてください。出力ファイルのカラムは、番号、フラグ、srcのカナ、refのカナとなります。入力されるカナの記述に表記揺れがあっても柔軟に対応してください。具体的には濁点、半濁点は取る、ひらがなや半角カタカナは全て全角カタカナに変換する。拗音などの小さなカタカナは全て大きなカタカナに変換する。全角スペース、半角スペースは全て取り除いてから両社を比較してください。出力ファイルのファイル名は kana_cmp.csv として、入力ファイルと同じディレクトリに出力してください。

### juki2mj プログラムの作成

data/juki2mj.csv にある変換表CSVを利用して、住基文字コードを文字情報基盤文字に変換するPythonプログラムを記述してください。基本動作は標準入力から受け取って標準出力に出力する。変換表は固定pathで、コマンドライン引数として入力ファイルを、オプションとして -o --outputでファイルが指定された場合には指定された名前のファイルに出力するようにしてください。
